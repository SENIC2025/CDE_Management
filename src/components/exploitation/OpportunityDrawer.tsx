import { useState, useEffect } from 'react';
import { supabase } from '../../lib/supabase';
import { useOrganisation } from '../../contexts/OrganisationContext';
import { useProject } from '../../contexts/ProjectContext';
import { ExploitationMetadataStore } from '../../lib/exploitationMetadata';
import {
  X,
  Save,
  Edit2,
  FileText,
  Calendar,
  User,
  Package,
  MessageSquare,
  Clock,
  CheckCircle2,
  AlertCircle,
  ChevronRight
} from 'lucide-react';

interface Opportunity {
  id: string;
  organisation_name: string;
  contact_person: string | null;
  stage: string;
  owner_user_id: string | null;
  next_action: string | null;
  notes: string | null;
  asset_id: string | null;
  created_at: string;
  updated_at: string;
}

interface Agreement {
  id: string;
  type: string;
  title: string;
  status: string;
  agreement_date: string | null;
  file_url: string | null;
  notes: string | null;
}

interface Asset {
  id: string;
  title: string;
  type: string;
}

interface OpportunityDrawerProps {
  opportunityId: string | null;
  onClose: () => void;
  onUpdated?: () => void;
}

export default function OpportunityDrawer({
  opportunityId,
  onClose,
  onUpdated
}: OpportunityDrawerProps) {
  const { currentOrganisation } = useOrganisation();
  const { currentProject } = useProject();
  const [opportunity, setOpportunity] = useState<Opportunity | null>(null);
  const [agreements, setAgreements] = useState<Agreement[]>([]);
  const [assets, setAssets] = useState<Asset[]>([]);
  const [linkedAsset, setLinkedAsset] = useState<Asset | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [activeTab, setActiveTab] = useState<'overview' | 'assets' | 'agreements' | 'timeline'>('overview');
  const [editing, setEditing] = useState(false);

  const [editedData, setEditedData] = useState({
    organisation_name: '',
    contact_person: '',
    stage: '',
    next_action: '',
    notes: ''
  });

  const [nextActionDue, setNextActionDue] = useState('');
  const [priority, setPriority] = useState<'low' | 'medium' | 'high'>('medium');
  const [newNote, setNewNote] = useState('');

  const stages = ['identified', 'engaged', 'negotiating', 'agreed', 'implemented', 'closed'];

  useEffect(() => {
    if (opportunityId && currentProject) {
      loadOpportunity();
      loadAgreements();
      loadAssets();
    }
  }, [opportunityId, currentProject]);

  async function loadOpportunity() {
    try {
      console.log('[Exploitation] Loading opportunity:', opportunityId);
      setLoading(true);

      const { data, error } = await supabase
        .from('uptake_opportunities')
        .select('*')
        .eq('id', opportunityId)
        .maybeSingle();

      if (error) throw error;

      if (data) {
        setOpportunity(data);
        setEditedData({
          organisation_name: data.organisation_name,
          contact_person: data.contact_person || '',
          stage: data.stage,
          next_action: data.next_action || '',
          notes: data.notes || ''
        });

        if (currentOrganisation && currentProject) {
          const metadata = ExploitationMetadataStore.getMetadata(
            currentOrganisation.id,
            currentProject.id,
            data.id
          );
          if (metadata) {
            setNextActionDue(metadata.nextActionDue || '');
            setPriority(metadata.priority || 'medium');
          }
        }

        if (data.asset_id) {
          loadLinkedAsset(data.asset_id);
        }
      }
    } catch (error: any) {
      console.error('[Exploitation] Error loading opportunity:', error);
      alert('Failed to load opportunity');
    } finally {
      setLoading(false);
    }
  }

  async function loadLinkedAsset(assetId: string) {
    try {
      const { data, error } = await supabase
        .from('result_assets')
        .select('id, title, type')
        .eq('id', assetId)
        .maybeSingle();

      if (error) throw error;
      setLinkedAsset(data);
    } catch (error: any) {
      console.error('[Exploitation] Error loading asset:', error);
    }
  }

  async function loadAgreements() {
    try {
      const { data, error } = await supabase
        .from('agreement_records')
        .select('*')
        .eq('opportunity_id', opportunityId)
        .order('created_at', { ascending: false });

      if (error) throw error;
      setAgreements(data || []);
    } catch (error: any) {
      console.error('[Exploitation] Error loading agreements:', error);
    }
  }

  async function loadAssets() {
    try {
      const { data, error } = await supabase
        .from('result_assets')
        .select('id, title, type')
        .eq('project_id', currentProject!.id)
        .order('title');

      if (error) throw error;
      setAssets(data || []);
    } catch (error: any) {
      console.error('[Exploitation] Error loading assets:', error);
    }
  }

  async function handleSave() {
    if (!opportunity) return;

    try {
      setSaving(true);
      console.log('[Exploitation] Saving opportunity');

      const { error } = await supabase
        .from('uptake_opportunities')
        .update({
          organisation_name: editedData.organisation_name,
          contact_person: editedData.contact_person || null,
          stage: editedData.stage,
          next_action: editedData.next_action || null,
          notes: editedData.notes || null,
          updated_at: new Date().toISOString()
        })
        .eq('id', opportunity.id);

      if (error) throw error;

      if (currentOrganisation && currentProject) {
        ExploitationMetadataStore.setMetadata(
          currentOrganisation.id,
          currentProject.id,
          opportunity.id,
          {
            nextActionDue,
            priority
          }
        );
      }

      await loadOpportunity();
      setEditing(false);
      if (onUpdated) onUpdated();
    } catch (error: any) {
      console.error('[Exploitation] Error saving opportunity:', error);
      alert('Failed to save changes');
    } finally {
      setSaving(false);
    }
  }

  async function handleStageChange(newStage: string) {
    if (!opportunity) return;

    try {
      const { error } = await supabase
        .from('uptake_opportunities')
        .update({ stage: newStage, updated_at: new Date().toISOString() })
        .eq('id', opportunity.id);

      if (error) throw error;

      await loadOpportunity();
      if (onUpdated) onUpdated();
    } catch (error: any) {
      console.error('[Exploitation] Error updating stage:', error);
      alert('Failed to update stage');
    }
  }

  async function handleLogFollowUp() {
    if (!opportunity || !newNote.trim()) return;

    try {
      const timestamp = new Date().toISOString();
      const existingNotes = opportunity.notes || '';
      const updatedNotes = existingNotes
        ? `${existingNotes}\n\n[${new Date().toLocaleString()}] ${newNote}`
        : `[${new Date().toLocaleString()}] ${newNote}`;

      const { error } = await supabase
        .from('uptake_opportunities')
        .update({
          notes: updatedNotes,
          updated_at: timestamp
        })
        .eq('id', opportunity.id);

      if (error) throw error;

      setNewNote('');
      await loadOpportunity();
      if (onUpdated) onUpdated();
    } catch (error: any) {
      console.error('[Exploitation] Error logging follow-up:', error);
      alert('Failed to log follow-up');
    }
  }

  async function handleLinkAsset(assetId: string) {
    if (!opportunity) return;

    try {
      const { error } = await supabase
        .from('uptake_opportunities')
        .update({ asset_id: assetId, updated_at: new Date().toISOString() })
        .eq('id', opportunity.id);

      if (error) throw error;

      await loadOpportunity();
      if (onUpdated) onUpdated();
    } catch (error: any) {
      console.error('[Exploitation] Error linking asset:', error);
      alert('Failed to link asset');
    }
  }

  const stageColors: Record<string, string> = {
    identified: 'bg-slate-100 text-slate-700 border-slate-300',
    engaged: 'bg-blue-100 text-blue-700 border-blue-300',
    negotiating: 'bg-yellow-100 text-yellow-700 border-yellow-300',
    agreed: 'bg-green-100 text-green-700 border-green-300',
    implemented: 'bg-teal-100 text-teal-700 border-teal-300',
    closed: 'bg-slate-200 text-slate-600 border-slate-400'
  };

  const priorityColors = {
    low: 'bg-slate-100 text-slate-700',
    medium: 'bg-blue-100 text-blue-700',
    high: 'bg-red-100 text-red-700'
  };

  if (!opportunityId) return null;

  if (loading) {
    return (
      <div className="fixed inset-y-0 right-0 w-full md:w-[600px] bg-white shadow-2xl border-l border-slate-200 z-50 flex items-center justify-center">
        <div className="text-slate-600">Loading opportunity...</div>
      </div>
    );
  }

  if (!opportunity) {
    return (
      <div className="fixed inset-y-0 right-0 w-full md:w-[600px] bg-white shadow-2xl border-l border-slate-200 z-50 flex flex-col">
        <div className="p-6 flex items-center justify-between border-b">
          <div className="text-red-600">Opportunity not found</div>
          <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg">
            <X className="h-5 w-5" />
          </button>
        </div>
      </div>
    );
  }

  const isStalled =
    currentOrganisation &&
    ExploitationMetadataStore.isStalled(
      opportunity.updated_at,
      ExploitationMetadataStore.getSettings(currentOrganisation.id).stalledThresholdDays
    );

  return (
    <div className="fixed inset-y-0 right-0 w-full md:w-[600px] bg-white shadow-2xl border-l border-slate-200 z-50 flex flex-col">
      <div className="border-b border-slate-200 px-6 py-4">
        <div className="flex items-center justify-between mb-3">
          <h2 className="text-xl font-bold text-slate-900">
            {opportunity.organisation_name}
          </h2>
          <div className="flex items-center gap-2">
            {!editing && (
              <button
                onClick={() => setEditing(true)}
                className="p-2 hover:bg-slate-100 rounded-lg"
              >
                <Edit2 className="h-4 w-4" />
              </button>
            )}
            {editing && (
              <button
                onClick={handleSave}
                disabled={saving}
                className="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm flex items-center gap-1"
              >
                <Save className="h-4 w-4" />
                {saving ? 'Saving...' : 'Save'}
              </button>
            )}
            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg">
              <X className="h-5 w-5" />
            </button>
          </div>
        </div>

        <div className="flex items-center gap-2 flex-wrap">
          <span className={`px-2 py-1 rounded border text-xs font-medium ${stageColors[opportunity.stage]}`}>
            {opportunity.stage.charAt(0).toUpperCase() + opportunity.stage.slice(1)}
          </span>
          {isStalled && (
            <span className="px-2 py-1 rounded bg-red-100 text-red-700 text-xs font-medium flex items-center gap-1">
              <AlertCircle className="h-3 w-3" />
              Stalled
            </span>
          )}
          {agreements.length === 0 && ['negotiating', 'agreed'].includes(opportunity.stage) && (
            <span className="px-2 py-1 rounded bg-amber-100 text-amber-700 text-xs font-medium">
              Needs Agreement
            </span>
          )}
          {!opportunity.owner_user_id && (
            <span className="px-2 py-1 rounded bg-slate-100 text-slate-600 text-xs font-medium">
              Unassigned
            </span>
          )}
        </div>

        <div className="flex gap-1 mt-3 border-t border-slate-200 pt-3">
          {(['overview', 'assets', 'agreements', 'timeline'] as const).map((tab) => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`px-3 py-1.5 text-sm font-medium rounded transition-colors ${
                activeTab === tab
                  ? 'bg-blue-100 text-blue-700'
                  : 'text-slate-600 hover:bg-slate-100'
              }`}
            >
              {tab.charAt(0).toUpperCase() + tab.slice(1)}
            </button>
          ))}
        </div>
      </div>

      <div className="flex-1 overflow-y-auto p-6">
        {activeTab === 'overview' && (
          <div className="space-y-6">
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-2">
                Organisation Name
              </label>
              {editing ? (
                <input
                  type="text"
                  value={editedData.organisation_name}
                  onChange={(e) =>
                    setEditedData({ ...editedData, organisation_name: e.target.value })
                  }
                  className="w-full px-3 py-2 border border-slate-300 rounded-lg"
                />
              ) : (
                <div className="text-lg font-semibold text-slate-900">
                  {opportunity.organisation_name}
                </div>
              )}
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-2">
                Contact Person
              </label>
              {editing ? (
                <input
                  type="text"
                  value={editedData.contact_person}
                  onChange={(e) =>
                    setEditedData({ ...editedData, contact_person: e.target.value })
                  }
                  className="w-full px-3 py-2 border border-slate-300 rounded-lg"
                />
              ) : (
                <div className="flex items-center gap-2 text-slate-700">
                  <User className="h-4 w-4" />
                  {opportunity.contact_person || 'Not specified'}
                </div>
              )}
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-2">Stage</label>
              {editing ? (
                <select
                  value={editedData.stage}
                  onChange={(e) => setEditedData({ ...editedData, stage: e.target.value })}
                  className="w-full px-3 py-2 border border-slate-300 rounded-lg"
                >
                  {stages.map((stage) => (
                    <option key={stage} value={stage}>
                      {stage.charAt(0).toUpperCase() + stage.slice(1)}
                    </option>
                  ))}
                </select>
              ) : (
                <div className="flex items-center gap-2">
                  <span className={`px-3 py-1.5 rounded border text-sm font-medium ${stageColors[opportunity.stage]}`}>
                    {opportunity.stage.charAt(0).toUpperCase() + opportunity.stage.slice(1)}
                  </span>
                  <div className="flex gap-1">
                    {stages.indexOf(opportunity.stage) > 0 && (
                      <button
                        onClick={() => handleStageChange(stages[stages.indexOf(opportunity.stage) - 1])}
                        className="p-1 hover:bg-slate-100 rounded text-slate-600"
                        title="Move back"
                      >
                        <ChevronRight className="h-4 w-4 rotate-180" />
                      </button>
                    )}
                    {stages.indexOf(opportunity.stage) < stages.length - 1 && (
                      <button
                        onClick={() => handleStageChange(stages[stages.indexOf(opportunity.stage) + 1])}
                        className="p-1 hover:bg-slate-100 rounded text-slate-600"
                        title="Move forward"
                      >
                        <ChevronRight className="h-4 w-4" />
                      </button>
                    )}
                  </div>
                </div>
              )}
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-2">Priority</label>
              <select
                value={priority}
                onChange={(e) => setPriority(e.target.value as any)}
                className="w-full px-3 py-2 border border-slate-300 rounded-lg"
              >
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-2">
                Next Action
              </label>
              {editing ? (
                <textarea
                  value={editedData.next_action}
                  onChange={(e) =>
                    setEditedData({ ...editedData, next_action: e.target.value })
                  }
                  rows={2}
                  className="w-full px-3 py-2 border border-slate-300 rounded-lg"
                />
              ) : (
                <div className="text-slate-700">
                  {opportunity.next_action || 'No next action defined'}
                </div>
              )}
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-2">
                Next Action Due
              </label>
              <input
                type="date"
                value={nextActionDue}
                onChange={(e) => setNextActionDue(e.target.value)}
                className="w-full px-3 py-2 border border-slate-300 rounded-lg"
              />
            </div>

            <div className="bg-slate-50 rounded-lg p-4">
              <div className="text-xs text-slate-500 mb-2">Last updated</div>
              <div className="text-sm font-medium text-slate-700">
                {ExploitationMetadataStore.formatRelativeDate(opportunity.updated_at)}
              </div>
            </div>
          </div>
        )}

        {activeTab === 'assets' && (
          <div className="space-y-4">
            <div>
              <h3 className="text-sm font-semibold text-slate-900 mb-3">Linked Asset</h3>
              {linkedAsset ? (
                <div className="bg-slate-50 rounded-lg p-4 flex items-center justify-between">
                  <div>
                    <div className="font-medium text-slate-900">{linkedAsset.title}</div>
                    <div className="text-xs text-slate-500">{linkedAsset.type}</div>
                  </div>
                  {editing && (
                    <button
                      onClick={() => handleLinkAsset('')}
                      className="text-sm text-red-600 hover:text-red-700"
                    >
                      Unlink
                    </button>
                  )}
                </div>
              ) : (
                <div className="text-sm text-slate-600 mb-3">No asset linked</div>
              )}
            </div>

            {editing && !linkedAsset && (
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-2">
                  Link Asset
                </label>
                <select
                  onChange={(e) => e.target.value && handleLinkAsset(e.target.value)}
                  className="w-full px-3 py-2 border border-slate-300 rounded-lg"
                  defaultValue=""
                >
                  <option value="">Select asset...</option>
                  {assets.map((asset) => (
                    <option key={asset.id} value={asset.id}>
                      {asset.title}
                    </option>
                  ))}
                </select>
              </div>
            )}

            {linkedAsset && agreements.length === 0 && (
              <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 flex items-start gap-2">
                <AlertCircle className="h-5 w-5 text-amber-600 flex-shrink-0" />
                <div className="text-sm text-amber-900">
                  <div className="font-medium mb-1">No exploitation agreement</div>
                  <div>
                    This asset is linked but has no agreement record. Consider creating one in the Agreements tab.
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {activeTab === 'agreements' && (
          <div className="space-y-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-sm font-semibold text-slate-900">Agreements</h3>
            </div>

            {agreements.length === 0 ? (
              <div className="text-center py-8 text-slate-600">
                <FileText className="h-8 w-8 mx-auto mb-2 text-slate-400" />
                <div className="text-sm">No agreements yet</div>
              </div>
            ) : (
              <div className="space-y-3">
                {agreements.map((agreement) => (
                  <div key={agreement.id} className="bg-slate-50 rounded-lg p-4">
                    <div className="flex items-start justify-between mb-2">
                      <div className="font-medium text-slate-900">{agreement.title}</div>
                      <span className="px-2 py-0.5 rounded bg-green-100 text-green-700 text-xs">
                        {agreement.type}
                      </span>
                    </div>
                    {agreement.agreement_date && (
                      <div className="text-xs text-slate-500 mb-1">
                        Date: {new Date(agreement.agreement_date).toLocaleDateString()}
                      </div>
                    )}
                    {agreement.notes && (
                      <div className="text-sm text-slate-600 mt-2">{agreement.notes}</div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {activeTab === 'timeline' && (
          <div className="space-y-4">
            <div>
              <h3 className="text-sm font-semibold text-slate-900 mb-3">Log Follow-up</h3>
              <textarea
                value={newNote}
                onChange={(e) => setNewNote(e.target.value)}
                placeholder="What happened? What's next?"
                rows={3}
                className="w-full px-3 py-2 border border-slate-300 rounded-lg mb-2"
              />
              <button
                onClick={handleLogFollowUp}
                disabled={!newNote.trim()}
                className="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm"
              >
                Log Follow-up
              </button>
            </div>

            <div>
              <h3 className="text-sm font-semibold text-slate-900 mb-3">Notes & History</h3>
              {opportunity.notes ? (
                <div className="bg-slate-50 rounded-lg p-4 text-sm text-slate-700 whitespace-pre-wrap">
                  {opportunity.notes}
                </div>
              ) : (
                <div className="text-sm text-slate-600">No notes yet</div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

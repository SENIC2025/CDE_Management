interface OpportunityMetadata {
  opportunityId: string;
  nextActionDue?: string;
  priority?: 'low' | 'medium' | 'high';
  lastFollowUp?: string;
  customFields?: Record<string, any>;
}

interface ExploitationSettings {
  stalledThresholdDays: number;
  showMyItemsFirst: boolean;
}

const STORAGE_PREFIX = 'exploitation_';

export class ExploitationMetadataStore {
  static getKey(orgId: string, projectId: string, opportunityId: string): string {
    return `${STORAGE_PREFIX}${orgId}_${projectId}_${opportunityId}`;
  }

  static getSettingsKey(orgId: string): string {
    return `${STORAGE_PREFIX}settings_${orgId}`;
  }

  static getMetadata(
    orgId: string,
    projectId: string,
    opportunityId: string
  ): OpportunityMetadata | null {
    try {
      const key = this.getKey(orgId, projectId, opportunityId);
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : null;
    } catch (error) {
      console.error('[ExploitationMetadata] Error reading metadata:', error);
      return null;
    }
  }

  static setMetadata(
    orgId: string,
    projectId: string,
    opportunityId: string,
    metadata: Partial<OpportunityMetadata>
  ): void {
    try {
      const key = this.getKey(orgId, projectId, opportunityId);
      const existing = this.getMetadata(orgId, projectId, opportunityId) || {
        opportunityId
      };
      const updated = { ...existing, ...metadata, opportunityId };
      localStorage.setItem(key, JSON.stringify(updated));
    } catch (error) {
      console.error('[ExploitationMetadata] Error saving metadata:', error);
    }
  }

  static getSettings(orgId: string): ExploitationSettings {
    try {
      const key = this.getSettingsKey(orgId);
      const data = localStorage.getItem(key);
      return data
        ? JSON.parse(data)
        : { stalledThresholdDays: 21, showMyItemsFirst: false };
    } catch (error) {
      console.error('[ExploitationMetadata] Error reading settings:', error);
      return { stalledThresholdDays: 21, showMyItemsFirst: false };
    }
  }

  static setSettings(orgId: string, settings: Partial<ExploitationSettings>): void {
    try {
      const key = this.getSettingsKey(orgId);
      const existing = this.getSettings(orgId);
      const updated = { ...existing, ...settings };
      localStorage.setItem(key, JSON.stringify(updated));
    } catch (error) {
      console.error('[ExploitationMetadata] Error saving settings:', error);
    }
  }

  static isStalled(
    updatedAt: string,
    stalledThresholdDays: number = 21
  ): boolean {
    const lastUpdate = new Date(updatedAt);
    const now = new Date();
    const daysSinceUpdate = Math.floor(
      (now.getTime() - lastUpdate.getTime()) / (1000 * 60 * 60 * 24)
    );
    return daysSinceUpdate > stalledThresholdDays;
  }

  static getDaysSinceUpdate(updatedAt: string): number {
    const lastUpdate = new Date(updatedAt);
    const now = new Date();
    return Math.floor(
      (now.getTime() - lastUpdate.getTime()) / (1000 * 60 * 60 * 24)
    );
  }

  static formatRelativeDate(date: string): string {
    const days = this.getDaysSinceUpdate(date);
    if (days === 0) return 'Today';
    if (days === 1) return 'Yesterday';
    if (days < 7) return `${days} days ago`;
    if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
    return `${Math.floor(days / 30)} months ago`;
  }
}

export type { OpportunityMetadata, ExploitationSettings };
